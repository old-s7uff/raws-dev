#!/bin/bash

mysql() {
         apt-get update; apt-get upgrade -y
         apt-get install mysql-server mysql-client -y
}

admin() {
        cd /hostdata/default/
        wget https://files.phpmyadmin.net/phpMyAdmin/4.7.0/phpMyAdmin-4.7.0-all-languages.zip
        unzip phpMyAdmin-4.7.0-all-languages.zip; rm -Rf phpMyAdmin-4.7.0-all-languages.zip
        mv phpMyAdmin-4.7.0-all-languages/ phpmyadmin
        chown -R www-data:www-data phpmyadmin/
        chown -R www-data:www-data phpmyadmin/*
        cd /hostdata/default/phpmyadmin/sql/
        mysql -u root -p < create_tables.sql
        cd /hostdata/default/phpmyadmin/
}
conf() {
cat <<EOF > /hostdata/default/phpmyadmin/config.inc.php
<?php
/*
 * Generated configuration file
 * Generated by: phpMyAdmin 4.7.0 setup script
 * Date: Mon, 08 May 2017 19:07:39 +0000
 */
/* Servers configuration */
$i = 0;
/* Server: localhost [1] */
$i++;
$cfg['Servers'][$i]['verbose'] = '';
$cfg['Servers'][$i]['host'] = 'localhost';
$cfg['Servers'][$i]['port'] = '';
$cfg['Servers'][$i]['socket'] = '';
$cfg['Servers'][$i]['auth_type'] = 'cookie';
$cfg['Servers'][$i]['user'] = 'root';
$cfg['Servers'][$i]['password'] = '';

/* End of servers configuration */

$cfg['blowfish_secret'] = 'changethekey';
$cfg['DefaultLang'] = 'en';
$cfg['ServerDefault'] = 1;
$cfg['UploadDir'] = '/tmp/';
$cfg['SaveDir'] = '/tmp/';
?>
EOF

echo "`openssl rand -base64 32`" > /hostdata/default/phpmyadmin/key.key
chkey="`cat /hostdata/default/phpmyadmin/key.key`"
sed -i "s/changethekey/$chkey/" /hostdata/default/phpmyadmin/config.inc.php
}

if [[ "$1" == 'isql' ]]; then
   mysql; admin; conf;
   clear
   fpm restart
   service nginx restart
   echo "# ============================================= #" | lolcat -a -s 100;
   echo "# ============================================= #" | lolcat -a -s 100;
   echo "$ PhpMyAdmin And Mysql Installed!. " | lolcat -a -s 100;
   echo "$ You should see phpmyadmin live at" | lolcat -a -s 100;
   ip="`curl -s api.ipify.org`"
   echo "$ http://$ip/phpmyadmin " | lolcat -a -s 100;
   echo "$ phpmyadmin conf ====> " | lolcat -a -s 100;
   echo "$ /hostdata/default/phpmyadmin/config.inc.php" | lolcat -a -s 100;
   echo "# ============================================= #" | lolcat -a -s 100;
   echo "# ============================================= #" | lolcat -a -s 100;
   
fi
